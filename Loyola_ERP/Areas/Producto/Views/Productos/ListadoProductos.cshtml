@{
    ViewData["Title"] = "Listado de productos";
}

<div class="container py-4">
    <h2 class="mb-4 text-success">Listado de productos</h2>
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form id="formFiltros" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="nombre" class="form-label fw-bold">Buscar por nombre:</label>
                    <input type="text" class="form-control" id="nombre" placeholder="Escriba para buscar..." autocomplete="off">
                </div>

                <div class="col-md-3">
                    <label for="filtroEstado" class="form-label fw-bold">Filtrar por estado:</label>
                    <select class="form-select" id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <a href="@Url.Action("Producto", "Productos", new { area = "Producto" })" class="btn btn-secondary">
                        Crear producto
                    </a>
                </div>

            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body" style="overflow-x: auto;">
            <table class="table table-hover align-middle" id="tablaProductos" style="min-width: 1200px;">
                <thead class="table-success">
                    <tr>
                        <th>Nombre</th>
                        <th>Código</th>
                        <th>Stock</th>
                        <th>Precio</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filas se generarán dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    $(document).ready(function () {
        cargarProductos();
    });

    $("#nombre").on("keyup", function () {
        cargarProductos();
    });

    $("#filtroEstado").on("change", function () {
        cargarProductos();
    });

    function cargarProductos() {

        // Obtener los valores de los filtros
        var nombre = $("#nombre").val();
        var estado = $("#filtroEstado").val();

        $.ajax({
            url: '@Url.Action("ObtenerProductos", "Productos", new { area = "Producto" })',
            type: "GET",
            data: {
                nombreBusqueda: nombre,
                estadoBusqueda: estado
            },
            dataType: "json",
            success: function (data) {

                const $tbody = $("#tablaProductos tbody");
                $tbody.empty();

                if (data && data.length > 0) {
                    $.each(data, function (index, producto) {

                        let badgeClass = '';
                        let estadoString = (producto.estadoNombre || '').toLowerCase().trim();

                        if (estadoString === 'activo') {
                            badgeClass = 'badge bg-success';
                        } else if (estadoString === 'inactivo') {
                            badgeClass = 'badge bg-danger';
                        } else {
                            badgeClass = 'badge bg-secondary';
                        }

                        // URL base a la acción Producto (será renderizada por Razor)
                        const urlProducto = '@Url.Action("Producto", "Productos", new { area = "Producto" })';

                        // Botón Editar: se añade producto.id como parámetro productoId
                        const btnEditar = `
                            <a href="${urlProducto}?productoId=${producto.id}" class="btn btn-sm btn-primary">
                                Editar
                            </a>
                        `;

                        const newRow = `
                            <tr>
                                <td>${producto.nombre}</td>
                                <td>${producto.codigo}</td>
                                <td>${producto.stock}</td>
                                <td>$${parseFloat(producto.precio).toFixed(2)}</td>
                                <td><span class="${badgeClass}">${producto.estadoNombre}</span></td>
                                <td>${btnEditar}</td>
                            </tr>
                        `;

                        $tbody.append(newRow);
                    });
                } else {
                    $tbody.append('<tr><td colspan="6" class="text-center">No hay productos registrados.</td></tr>');
                }
            },
            error: function (xhr, status, error) {
                console.error("Error al cargar productos:", status, error, xhr.responseText);
                $("#tablaProductos tbody").html('<tr><td colspan="6" class="text-danger text-center">Error al cargar el listado.</td></tr>');
            }
        });
    }
</script>